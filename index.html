<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Quiz Master IDB</title>
    <style>
        /* --- NATIVE APP THEME --- */
        :root {
            --primary: #6366f1;
            --primary-active: #4f46e5;
            --primary-light: #e0e7ff;
            
            --bg-app: #f2f2f7;
            --bg-surface: #ffffff;
            --bg-header: rgba(255, 255, 255, 0.95);
            --bg-tabbar: rgba(255, 255, 255, 0.98);
            
            --text-main: #000000;
            --text-secondary: #8e8e93;
            
            --border: #c6c6c8;
            --separator: #e5e5ea;
            
            --danger: #ff3b30;
            --success: #34c759;
            --warning: #ffcc00;
            --blue: #007aff;
            --radius-card: 16px;
            --radius-btn: 12px;
            
            --shadow-card: 0 2px 8px rgba(0,0,0,0.04);
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
            
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            --font-scale: 1;
        }
        [data-theme="dark"] {
            --bg-app: #000000;
            --bg-surface: #1c1c1e;
            --bg-header: rgba(28, 28, 30, 0.95);
            --bg-tabbar: rgba(28, 28, 30, 0.98);
            --text-main: #ffffff;
            --text-secondary: #98989d;
            --border: #38383a;
            --separator: #38383a;
            --primary-light: #313136;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            font-family: var(--font-stack);
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0; padding: 0;
            font-size: calc(16px * var(--font-scale));
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* --- LAYOUT STRUCTURE --- */
        #app-container {
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
        }
        .app-header {
            position: fixed; top: 0; left: 0; right: 0;
            height: calc(56px + var(--safe-area-top));
            padding-top: var(--safe-area-top);
            background: var(--bg-header);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-bottom: 0.5px solid var(--separator);
            z-index: 50;
            display: flex; align-items: center; justify-content: center;
        }
        .header-title { font-weight: 700; font-size: 17px; }
        .header-btn {
            position: absolute; top: calc(var(--safe-area-top) + 10px);
            padding: 6px 14px; 
            font-size: 14px; 
            font-weight: 600;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            display: flex; align-items: center; justify-content: center;
            height: 36px;
        }
        .header-btn:active { transform: scale(0.96); opacity: 0.8; }
        .header-btn.left { 
            left: 12px; 
            background: rgba(120, 120, 128, 0.12);
            color: var(--text-main); 
            border: none;
        }
        [data-theme="dark"] .header-btn.left { background: rgba(120, 120, 128, 0.24); }
        .header-btn.right { 
            right: 12px; 
            background: var(--blue); 
            color: white; 
            border: none;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.25);
        }

        .view-container {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-top: calc(66px + var(--safe-area-top)); 
            padding-bottom: calc(80px + var(--safe-area-bottom));
            background: var(--bg-app);
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .view-container.active { display: block; opacity: 1; }

        .tab-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: calc(60px + var(--safe-area-bottom));
            padding-bottom: var(--safe-area-bottom);
            background: var(--bg-tabbar);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid var(--separator);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 90;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        .tab-item {
            flex: 1; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-secondary);
            font-size: 10px; font-weight: 500;
            gap: 4px; cursor: pointer;
        }
        .tab-item svg { width: 24px; height: 24px; fill: currentColor; }
        .tab-item.active { color: var(--blue); }

        .full-screen-overlay {
            position: fixed; inset: 0;
            background: var(--bg-app);
            z-index: 100;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
            padding-top: var(--safe-area-top);
        }
        .full-screen-overlay.open { transform: translateY(0); }

        /* --- COMPONENTS --- */
        .card-grid { display: grid; grid-template-columns: 1fr; gap: 16px; padding: 16px; }
        .quiz-card {
            background: var(--bg-surface);
            border-radius: var(--radius-card);
            padding: 16px;
            box-shadow: var(--shadow-card);
            display: flex; flex-direction: column;
        }
        .quiz-card:active { opacity: 0.7; }
        .list-group { background: var(--bg-surface); border-radius: 12px; margin: 16px; overflow: hidden; }
        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 0.5px solid var(--separator); min-height: 48px; }
        .list-item:last-child { border-bottom: none; }
        .list-header { margin: 24px 16px 8px; font-size: 13px; color: var(--text-secondary); text-transform: uppercase; font-weight: 500; }
        .btn { background: var(--blue); color: white; border: none; padding: 14px; border-radius: var(--radius-btn); font-size: 16px; font-weight: 600; text-align: center; cursor: pointer; width: 100%; }
        .btn-outline { background: transparent; border: 1px solid var(--blue); color: var(--blue); }
        .btn-danger { background: var(--danger); color: white; }
        
        input, textarea, select { width: 100%; padding: 12px; background: var(--bg-app); border: none; border-radius: 10px; color: var(--text-main); font-size: 16px; }
        
        .fab {
            position: fixed; bottom: calc(80px + var(--safe-area-bottom)); right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--blue); color: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 80;
            font-size: 30px; cursor: pointer;
        }

        .hidden { display: none !important; }
        .flex { display: flex; } 
        .flex-col { flex-direction: column; }
        .gap-2 { gap: 8px; } .justify-between { justify-content: space-between; }
        .text-muted { color: var(--text-secondary); }
        .file-item { background: var(--bg-surface); padding: 12px 16px; border-bottom: 0.5px solid var(--separator); display: flex; align-items: center; gap: 12px; }

        .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e9e9ea; border-radius: 34px; transition: .3s; }
        [data-theme="dark"] .slider { background-color: #39393d; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; border-radius: 50%; transition: .3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

<div id="app-container">
    <header class="app-header">
        <div class="header-title" id="nav-title">Library</div>
    </header>

    <div id="view-library" class="view-container active">
        <div id="quiz-list" class="card-grid"></div>
        <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px;">
            Tap + to add a new quiz
        </div>
    </div>

    <div id="view-files" class="view-container">
        <div class="list-group" style="margin-top: 0;">
            <div class="list-item">
                <div class="flex gap-2" style="width: 100%;">
                    <label class="btn btn-outline" style="flex:1; padding: 8px; font-size: 14px;">
                        Import
                        <input type="file" hidden accept=".json" onchange="handleImport(this)" multiple>
                    </label>
                    <button onclick="exportAll()" class="btn btn-outline" style="flex:1; padding: 8px; font-size: 14px;">Export</button>
                    <button onclick="bulkDelete()" class="btn btn-danger" style="flex:1; padding: 8px; font-size: 14px;">Delete</button>
                </div>
            </div>
            <div class="list-header flex justify-between">
                <span>Stored Quizzes (IndexedDB)</span>
                <span onclick="selectAllFiles()" style="color:var(--blue);cursor:pointer;">Select All</span>
            </div>
        </div>
        <div id="file-list-container"></div>
    </div>

    <div id="view-settings" class="view-container">
        <div class="list-header">Appearance</div>
        <div class="list-group">
            <div class="list-item">
                <span>Dark Mode</span>
                <label class="switch"><input type="checkbox" id="dark-mode-toggle" onchange="toggleTheme(this.checked)"><span class="slider"></span></label>
            </div>
            <div class="list-item" style="flex-direction: column; align-items: flex-start;">
                <span style="margin-bottom: 8px;">Font Size</span>
                <input type="range" style="width:100%" min="0.8" max="1.3" step="0.1" id="font-slider" onchange="setFontSize(this.value)">
            </div>
        </div>
        <div class="list-header">Developer Tools</div>
        <div class="list-group">
            <div class="list-item" style="display: block;">
                <textarea id="json-paste" rows="5" placeholder="Paste Raw JSON here..." style="font-family: monospace; font-size: 12px;"></textarea>
                <button onclick="importRaw()" class="btn" style="margin-top: 8px;">Import Raw JSON</button>
            </div>
        </div>
        <div class="list-group">
            <div class="list-item" onclick="deleteAllData()" style="justify-content: center; cursor: pointer;">
                <span style="color: var(--danger); font-weight: 600;">Reset Database</span>
            </div>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" onclick="switchTab('library', this)">
            <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/></svg>
            Library
        </div>
        <div class="tab-item" onclick="switchTab('files', this)">
            <svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>
            Files
        </div>
        <div class="tab-item" onclick="switchTab('settings', this)">
            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.04.17 0 .4.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.04-.22 0-.45-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            Settings
        </div>
    </nav>

    <div class="fab" id="fab-add" onclick="openEditor()">+</div>
</div>

<div id="overlay-editor" class="full-screen-overlay">
    <div class="app-header" style="position: absolute;">
        <button class="header-btn left" onclick="closeOverlay('overlay-editor')">Cancel</button>
        <div class="header-title">Edit Quiz</div>
        <button class="header-btn right" onclick="saveQuiz()">Save</button>
    </div>
    <div style="flex:1; overflow-y:auto; padding: 76px 16px 20px;">
        <div class="list-group" style="margin:0 0 20px 0;">
            <div class="list-item">
                <input type="text" id="edit-title" placeholder="Quiz Title" style="font-weight:700;">
            </div>
        </div>
        <div id="edit-questions-list"></div>
        <button onclick="addQuestion()" class="btn btn-outline" style="margin-top:20px; border-style:dashed;">+ Add Question</button>
        <br><br>
    </div>
</div>

<div id="overlay-start" class="full-screen-overlay" style="justify-content: flex-end; background: rgba(0,0,0,0.5);">
    <div style="background: var(--bg-surface); border-radius: 20px 20px 0 0; padding: 24px; animation: slideUp 0.3s;">
        <h2 style="margin: 0 0 20px 0;">Quiz Setup</h2>
        <div class="flex gap-2 mb-4">
            <div style="flex:1">
                <label class="text-secondary text-xs uppercase font-bold">Time (Min)</label>
                <input type="number" id="play-timer" placeholder="None" style="background: var(--bg-app);">
            </div>
            <div style="flex:1">
                <label class="text-secondary text-xs uppercase font-bold">Penalty</label>
                <select id="play-penalty" style="background: var(--bg-app);">
                    <option value="0">None</option>
                    <option value="0.25">-0.25</option>
                    <option value="0.5">-0.50</option>
                </select>
            </div>
        </div>
        <div class="list-group" style="margin: 0 0 20px 0;">
            <div class="list-item">
                <span>Shuffle</span>
                <label class="switch"><input type="checkbox" id="play-shuffle"><span class="slider"></span></label>
            </div>
            <div class="list-item">
                <span>Exam Mode</span>
                <label class="switch"><input type="checkbox" id="play-mode" checked><span class="slider"></span></label>
            </div>
        </div>
        <button onclick="startQuiz()" class="btn">Start Quiz</button>
        <button onclick="closeOverlay('overlay-start')" class="btn btn-outline" style="border:none; margin-top:10px;">Cancel</button>
    </div>
</div>

<div id="overlay-player" class="full-screen-overlay">
    <div class="app-header" style="position: absolute;">
        <button class="header-btn left" onclick="closeOverlay('overlay-player')">Exit</button>
        <div class="header-title" id="game-progress">Q 1/10</div>
        <div class="header-btn right" id="game-timer-display" style="background: transparent; color: var(--text-main); box-shadow: none; pointer-events: none;"></div>
    </div>
    <div style="flex:1; overflow-y:auto; padding: 76px 20px 100px;">
        <div style="height:4px; background:var(--separator); border-radius:2px; margin-bottom:20px; overflow:hidden;">
            <div id="game-bar" style="height:100%; width:0%; background:var(--blue); transition:width 0.3s;"></div>
        </div>
        <div id="game-paragraph" class="list-group hidden" style="margin:0 0 20px 0; background:#f0f9ff; border:1px solid #bae6fd;">
            <div class="list-item" style="border:none; padding:16px;">
                <p id="game-p-text" style="font-size:14px; line-height:1.5; color:#0c4a6e; margin:0;"></p>
            </div>
        </div>
        <h2 id="game-q-text" style="font-size:20px; font-weight:700; margin-bottom:24px;"></h2>
        <div id="game-options" class="flex-col gap-2 flex"></div>
    </div>
    <div style="position:absolute; bottom:0; left:0; right:0; padding:20px; background:var(--bg-tabbar); border-top:0.5px solid var(--separator); display: flex; gap: 10px;">
        <button id="btn-prev" onclick="prevQ()" class="btn btn-outline" style="flex:1;">Prev</button>
        <button id="btn-skip" onclick="skipQ()" class="btn btn-outline" style="flex:1;">Skip</button>
        <button id="btn-next" onclick="nextQ()" class="btn" style="flex:2;">Next</button>
    </div>
</div>

<div id="overlay-results" class="full-screen-overlay">
    <div style="padding: 80px 20px; text-align: center; overflow-y: auto;">
        <h1 id="res-score" style="font-size: 64px; margin:0; color:var(--blue);">0</h1>
        <p class="text-secondary font-bold uppercase">Total Score</p>
        
        <div class="card-grid" style="grid-template-columns: 1fr 1fr; margin-top:40px;">
            <div class="quiz-card" style="align-items:center;">
                <span class="text-success" style="font-size:24px; font-weight:700;" id="res-correct">0</span>
                <span class="text-secondary text-xs uppercase">Correct</span>
            </div>
            <div class="quiz-card" style="align-items:center;">
                <span class="text-danger" style="font-size:24px; font-weight:700;" id="res-wrong">0</span>
                <span class="text-secondary text-xs uppercase">Wrong</span>
            </div>
            <div class="quiz-card" style="align-items:center;">
                <span class="text-warning" style="font-size:24px; font-weight:700;" id="res-skip">0</span>
                <span class="text-secondary text-xs uppercase">Skipped</span>
            </div>
            <div class="quiz-card" style="align-items:center;">
                <span class="text-danger" style="font-size:24px; font-weight:700;" id="res-pen">0</span>
                <span class="text-secondary text-xs uppercase">Penalty</span>
            </div>
        </div>
        <button onclick="closeOverlay('overlay-results')" class="btn" style="margin-top:40px;">Done</button>
    </div>
</div>

<script>
    /**
     * INDEXED DB MANAGER
     * Handles asynchronous storage using browser's native IndexedDB.
     */
    const DB_NAME = 'QuizMasterDB';
    const DB_VERSION = 1;
    const STORE_QUIZZES = 'quizzes';
    const STORE_SETTINGS = 'settings';

    const dbManager = {
        db: null,
        
        open: function() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_QUIZZES)) {
                        db.createObjectStore(STORE_QUIZZES, { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains(STORE_SETTINGS)) {
                        db.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
                    }
                };
                request.onsuccess = (e) => {
                    this.db = e.target.result;
                    resolve(this.db);
                };
                request.onerror = (e) => reject('DB Error: ' + e.target.error);
            });
        },

        getAllQuizzes: function() {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction(STORE_QUIZZES, 'readonly');
                const store = tx.objectStore(STORE_QUIZZES);
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        },

        saveQuiz: function(quiz) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction(STORE_QUIZZES, 'readwrite');
                const store = tx.objectStore(STORE_QUIZZES);
                const req = store.put(quiz);
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });
        },

        deleteQuiz: function(id) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction(STORE_QUIZZES, 'readwrite');
                const store = tx.objectStore(STORE_QUIZZES);
                const req = store.delete(id);
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });
        },

        getSettings: function() {
            return new Promise((resolve) => {
                const tx = this.db.transaction(STORE_SETTINGS, 'readonly');
                const store = tx.objectStore(STORE_SETTINGS);
                const req = store.get('app_settings');
                req.onsuccess = () => resolve(req.result ? req.result.value : null);
                req.onerror = () => resolve(null);
            });
        },

        saveSettings: function(settings) {
            const tx = this.db.transaction(STORE_SETTINGS, 'readwrite');
            const store = tx.objectStore(STORE_SETTINGS);
            store.put({ key: 'app_settings', value: settings });
        },

        clearAll: function() {
            return new Promise((resolve) => {
                const tx = this.db.transaction([STORE_QUIZZES, STORE_SETTINGS], 'readwrite');
                tx.objectStore(STORE_QUIZZES).clear();
                tx.objectStore(STORE_SETTINGS).clear();
                tx.oncomplete = () => resolve();
            });
        }
    };

    // --- STATE ---
    // We keep a local copy in memory for UI rendering, but sync with IDB
    let quizzes = []; 
    let settings = { darkMode: false, fontSize: 1 };
    
    let activeQuiz, editState, playSession, selectedFiles = new Set();

    // --- INIT ---
    async function init() {
        try {
            await dbManager.open();
            
            // Load Settings
            const savedSettings = await dbManager.getSettings();
            if (savedSettings) settings = savedSettings;
            applySettings();

            // Load Quizzes
            await refreshLocalData();
            
            // Initial Render
            switchTab('library', document.querySelector('.tab-item:first-child'));
        } catch (e) {
            console.error("Initialization Failed:", e);
            alert("Could not open Database. Please ensure you are not in Incognito mode or that your browser supports IndexedDB.");
        }
    }

    async function refreshLocalData() {
        quizzes = await dbManager.getAllQuizzes();
        // Sort by newest first based on ID (timestamp)
        quizzes.sort((a, b) => b.id - a.id); 
    }

    // --- NAVIGATION ---
    function switchTab(tabId, el) {
        document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(`view-${tabId}`).classList.add('active');
        if(el) el.classList.add('active');
        
        const titles = { 'library': 'My Library', 'files': 'File Manager', 'settings': 'Settings' };
        document.getElementById('nav-title').innerText = titles[tabId];
        document.getElementById('fab-add').style.display = tabId === 'library' ? 'flex' : 'none';
        
        if(tabId === 'library') renderLibrary();
        if(tabId === 'files') renderFiles();
    }

    function openOverlay(id) { document.getElementById(id).classList.add('open'); }
    function closeOverlay(id) { document.getElementById(id).classList.remove('open'); }

    // --- LIBRARY ---
    function renderLibrary() {
        const list = document.getElementById('quiz-list'); list.innerHTML = '';
        if(!quizzes.length) { list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">No Quizzes Found.<br>Tap + to create one.</div>'; return; }
        
        quizzes.forEach((q, i) => {
            const card = document.createElement('div'); card.className = 'quiz-card';
            card.innerHTML = `
                <div style="font-weight:700; font-size:18px; margin-bottom:4px;">${q.title}</div>
                <div style="font-size:13px; color:var(--text-secondary); margin-bottom:16px;">${q.questions.length} Questions</div>
                <div class="flex gap-2">
                    <button onclick="prepStart(${i})" class="btn" style="padding:10px; font-size:14px;">Play</button>
                    <button onclick="prepEdit(${i})" class="btn btn-outline" style="padding:10px; font-size:14px;">Edit</button>
                </div>`;
            list.appendChild(card);
        });
    }

    // --- FILES ---
    function renderFiles() {
        const div = document.getElementById('file-list-container'); div.innerHTML = '';
        selectedFiles.clear();
        quizzes.forEach((q, i) => {
            const item = document.createElement('div'); item.className = 'file-item';
            item.innerHTML = `
                <input type="checkbox" onchange="toggleSel(${i}, this.checked)" style="width:20px;height:20px;">
                <div style="flex:1;">
                    <div style="font-weight:600;">${q.title}</div>
                    <div style="font-size:12px;color:var(--text-secondary);">ID: ${q.id}</div>
                </div>`;
            div.appendChild(item);
        });
    }

    function toggleSel(i, c) { if(c) selectedFiles.add(i); else selectedFiles.delete(i); }
    function selectAllFiles() { document.querySelectorAll('#file-list-container input').forEach(c=>{c.checked=true; c.onchange({target:c}); toggleSel(Array.from(c.parentNode.parentNode.children).indexOf(c.parentNode), true);}); }
    
    async function bulkDelete() {
        if(!selectedFiles.size) return;
        if(!confirm(`Delete ${selectedFiles.size} items?`)) return;
        
        const idxs = Array.from(selectedFiles);
        // We must delete by ID, not index
        for (let i of idxs) {
            await dbManager.deleteQuiz(quizzes[i].id);
        }
        await refreshLocalData();
        renderFiles();
    }

    function exportAll() {
        const blob = new Blob([JSON.stringify(quizzes)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'quiz_backup.json'; a.click();
    }

    function handleImport(inp) {
        Array.from(inp.files).forEach(f => {
            const r = new FileReader();
            r.onload = async e => { 
                try {
                    const d = JSON.parse(e.target.result);
                    const list = Array.isArray(d) ? d : [d];
                    for (let q of list) {
                        q.id = Date.now() + Math.random(); // Ensure new ID on import
                        await dbManager.saveQuiz(q);
                    }
                    await refreshLocalData();
                    renderFiles();
                    alert('Import Successful');
                } catch(x){ alert('Invalid JSON'); }
            };
            r.readAsText(f);
        });
    }

    // --- EDITOR ---
    function openEditor() { 
        editState = { id: Date.now(), title:'', questions:[] }; 
        renderEditor(); 
        openOverlay('overlay-editor'); 
    }
    
    function prepEdit(i) { 
        // Deep copy to avoid editing the array directly before saving
        editState = JSON.parse(JSON.stringify(quizzes[i])); 
        renderEditor(); 
        openOverlay('overlay-editor'); 
    }
    
    function renderEditor() {
        document.getElementById('edit-title').value = editState.title;
        const list = document.getElementById('edit-questions-list'); list.innerHTML = '';
        editState.questions.forEach((q, idx) => {
            const wrap = document.createElement('div'); wrap.className = 'list-group';
            wrap.innerHTML = `
                <div class="list-header flex justify-between"><span>Question ${idx+1}</span><span style="color:red;" onclick="delQ(${idx})">Delete</span></div>
                <div class="list-item"><textarea oninput="updQ(${idx},'text',this.value)" rows="2" placeholder="Question Text">${q.text}</textarea></div>
                <div class="list-item"><textarea oninput="updQ(${idx},'paragraph',this.value)" rows="2" placeholder="Optional Paragraph">${q.paragraph||''}</textarea></div>
                ${q.options.map((o,i)=>`<div class="list-item"><input type="radio" name="eo${idx}" ${q.correct===i?'checked':''} onchange="updQ(${idx},'correct',${i})"><input style="margin-left:10px;" value="${o}" oninput="updOpt(${idx},${i},this.value)" placeholder="Option ${i+1}"></div>`).join('')}
            `;
            list.appendChild(wrap);
        });
    }

    function addQuestion() { editState.questions.push({text:'', options:['','','',''], correct:0}); renderEditor(); }
    function delQ(i) { editState.questions.splice(i,1); renderEditor(); }
    function updQ(i,k,v) { editState.questions[i][k]=v; }
    function updOpt(qi,oi,v) { editState.questions[qi].options[oi]=v; }
    
    async function saveQuiz() {
        editState.title = document.getElementById('edit-title').value || 'Untitled';
        
        await dbManager.saveQuiz(editState);
        await refreshLocalData(); // Sync DB to RAM
        
        closeOverlay('overlay-editor'); 
        renderLibrary();
    }

    // --- PLAYER ---
    function prepStart(i) { activeQuiz = quizzes[i]; openOverlay('overlay-start'); }
    
    function startQuiz() {
        closeOverlay('overlay-start');
        const tm = parseInt(document.getElementById('play-timer').value);
        playSession = {
            qIdxs: [...Array(activeQuiz.questions.length).keys()], curr: 0, ans: [],
            timer: tm ? tm*60 : null, left: tm ? tm*60 : 0,
            penalty: parseFloat(document.getElementById('play-penalty').value),
            shuffle: document.getElementById('play-shuffle').checked,
            examMode: document.getElementById('play-mode').checked
        };
        if(playSession.shuffle) playSession.qIdxs.sort(()=>Math.random()-0.5);
        if(playSession.timer) startTimer();
        openOverlay('overlay-player'); loadQ();
    }

    function startTimer() {
        document.getElementById('game-timer-display').innerText = fmtTime(playSession.left);
        playSession.timerId = setInterval(() => {
            playSession.left--;
            document.getElementById('game-timer-display').innerText = fmtTime(playSession.left);
            if(playSession.left <= 0) finishGame();
        }, 1000);
    }
    function fmtTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
    
    function loadQ() {
        const qIdx = playSession.qIdxs[playSession.curr];
        const q = activeQuiz.questions[qIdx];
        document.getElementById('game-progress').innerText = `Q ${playSession.curr+1}/${playSession.qIdxs.length}`;
        document.getElementById('game-bar').style.width = `${((playSession.curr)/playSession.qIdxs.length)*100}%`;
        document.getElementById('game-q-text').innerText = q.text;
        
        const pBox = document.getElementById('game-paragraph');
        if(q.paragraph) { pBox.classList.remove('hidden'); document.getElementById('game-p-text').innerText = q.paragraph; }
        else pBox.classList.add('hidden');
        const opts = document.getElementById('game-options'); opts.innerHTML = '';
        
        const existingAns = playSession.ans.find(a => a.q === qIdx);
        
        q.options.forEach((o, i) => {
            const btn = document.createElement('button'); btn.className = 'btn btn-outline';
            btn.style.textAlign='left'; btn.style.justifyContent='flex-start'; btn.innerText = o;
            
            if(existingAns) {
                if(i === existingAns.c) {
                    if (playSession.examMode) {
                        btn.style.background = 'var(--blue)'; btn.style.color = 'white';
                    } else if (existingAns.ok) {
                        btn.style.background = 'var(--success)'; btn.style.color = 'white'; btn.style.borderColor='transparent';
                    } else {
                        btn.style.background = 'var(--danger)'; btn.style.color = 'white'; btn.style.borderColor='transparent';
                    }
                } else if (!playSession.examMode && !existingAns.ok && i === q.correct) {
                    btn.style.background = 'var(--success)'; btn.style.color = 'white'; btn.style.borderColor='transparent';
                }
                if (!playSession.examMode) btn.disabled = true;
            }
            btn.onclick = () => handleAns(i, btn, q.correct);
            opts.appendChild(btn);
        });

        document.getElementById('btn-prev').disabled = (playSession.curr === 0);
        
        if (playSession.curr === playSession.qIdxs.length - 1) {
            document.getElementById('btn-next').innerText = "Finish";
        } else {
            document.getElementById('btn-next').innerText = "Next";
        }
        
        if (!playSession.examMode) {
             if(existingAns) {
                 document.getElementById('btn-next').style.display = 'block';
                 document.getElementById('btn-skip').style.display = 'none';
             } else {
                 document.getElementById('btn-next').style.display = 'none';
                 document.getElementById('btn-skip').style.display = 'block';
             }
        } else {
            document.getElementById('btn-next').style.display = 'block';
            document.getElementById('btn-skip').style.display = existingAns ? 'none' : 'block';
        }
    }

    function handleAns(c, btn, cor) {
        const qIdx = playSession.qIdxs[playSession.curr];
        const existingIdx = playSession.ans.findIndex(a => a.q === qIdx);
        if (existingIdx > -1) playSession.ans[existingIdx] = {q: qIdx, c: c, ok: c===cor};
        else playSession.ans.push({q: qIdx, c: c, ok: c===cor});

        if(!playSession.examMode) {
            Array.from(document.getElementById('game-options').children).forEach(b=>b.disabled=true);
            if(c===cor) { btn.style.background='var(--success)'; btn.style.color='white'; btn.style.borderColor='transparent'; }
            else { 
                btn.style.background='var(--danger)'; btn.style.color='white'; btn.style.borderColor='transparent'; 
                document.getElementById('game-options').children[cor].style.background='var(--success)'; document.getElementById('game-options').children[cor].style.color='white'; 
            }
            document.getElementById('btn-next').style.display='block'; 
            document.getElementById('btn-skip').style.display='none';
        } else {
            Array.from(document.getElementById('game-options').children).forEach(b => {
                b.style.background = 'transparent'; b.style.color = 'var(--blue)';
            });
            btn.style.background = 'var(--blue)'; btn.style.color = 'white';
            document.getElementById('btn-skip').style.display='none';
        }
    }
    
    function prevQ() { if(playSession.curr > 0) { playSession.curr--; loadQ(); } }
    
    function skipQ() { 
        const qIdx = playSession.qIdxs[playSession.curr];
        const existingIdx = playSession.ans.findIndex(a => a.q === qIdx);
        if (existingIdx > -1) playSession.ans.splice(existingIdx, 1);
        playSession.ans.push({q:qIdx, c:-1, ok:false, skip:true}); 
        nextQ(); 
    }
    
    function nextQ() { 
        if(playSession.curr < playSession.qIdxs.length-1) { playSession.curr++; loadQ(); } 
        else { finishGame(); }
    }
    
    function finishGame() {
        if(playSession.timerId) clearInterval(playSession.timerId);
        closeOverlay('overlay-player');
        let c=0, w=0, s=0;
        playSession.ans.forEach(a => { if(a.skip) s++; else if(a.ok) c++; else w++; });
        document.getElementById('res-score').innerText = (c - (w * playSession.penalty)).toFixed(2);
        document.getElementById('res-correct').innerText = c;
        document.getElementById('res-wrong').innerText = w;
        document.getElementById('res-skip').innerText = s;
        document.getElementById('res-pen').innerText = (w * playSession.penalty).toFixed(2);
        openOverlay('overlay-results');
    }

    // --- SYSTEM ---
    function toggleTheme(c) { 
        settings.darkMode = c; 
        dbManager.saveSettings(settings); 
        applySettings(); 
    }
    function setFontSize(v) { 
        settings.fontSize = v; 
        dbManager.saveSettings(settings); 
        applySettings(); 
    }
    function applySettings() {
        if(settings.darkMode) document.documentElement.setAttribute('data-theme', 'dark'); else document.documentElement.removeAttribute('data-theme');
        document.documentElement.style.setProperty('--font-scale', settings.fontSize);
        document.getElementById('dark-mode-toggle').checked = settings.darkMode;
        document.getElementById('font-slider').value = settings.fontSize;
    }
    async function importRaw() { 
        try { 
            const d=JSON.parse(document.getElementById('json-paste').value); 
            const list = Array.isArray(d) ? d : [d];
            for(let q of list) { q.id = Date.now() + Math.random(); await dbManager.saveQuiz(q); }
            await refreshLocalData();
            alert('Imported!'); 
        } catch(e){alert('Error');} 
    }
    async function deleteAllData() { 
        if(confirm('Reset all Application Data? This cannot be undone.')) { 
            await dbManager.clearAll();
            location.reload(); 
        } 
    }

    // Start App
    init();

</script>
</body>
                    </html>
